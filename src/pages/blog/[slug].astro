---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { Button, Section } from '@/components/ui';
import { BOOK_SERIES, getBooksBySeriesId, getAmazonUrl, generateBreadcrumbSchema } from '@/data/products';
import { getLandingPageBySlug } from '@/data/landing-pages';
import ExitIntentPopup from '@/components/ExitIntentPopup.astro';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post, index) => ({
    params: { slug: post.id.replace(/\.md$/, '') },
    props: { post, index },
  }));
}

const { post, index } = Astro.props;

// Rotate CTA variant: 0=inline-banner, 1=format-list, 2=minimal
const ctaVariant = index % 3;
const { Content } = await render(post);
const postSlug = post.id.replace(/\.md$/, '');

// Related blog posts: same category, excluding current post, limit to 3
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter((p) => p.data.category === post.data.category && p.id !== post.id)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

// Extract deity name for context-aware exit intent popup
// For deity posts, extract the deity name from the title (e.g., "Goddess Parvati: The Loving Mother" -> "Parvati")
const deityContextHint = post.data.category === 'deity'
  ? post.data.title
      .replace(/^(Lord|Goddess|Meet)\s+/i, '')
      .replace(/[:\u2014\u2013\u2012].*$/, '')
      .trim()
  : undefined;

// Determine which books to show
const seriesToShow = post.data.relatedBook === 'deities'
  ? BOOK_SERIES.filter((s) => s.id === 'marvelous-hindu-deities')
  : post.data.relatedBook === 'shloka'
    ? BOOK_SERIES.filter((s) => s.id === 'shloka-mantra')
    : BOOK_SERIES;

// Related landing page
const relatedPage = post.data.relatedSlug ? getLandingPageBySlug(post.data.relatedSlug) : null;

// Schemas
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: 'https://rootsonrise.com' },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://rootsonrise.com/blog' },
    { '@type': 'ListItem', position: 3, name: post.data.title, item: `https://rootsonrise.com/blog/${postSlug}` },
  ],
};

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date.toISOString(),
  author: { '@type': 'Organization', name: 'Roots On Rise', url: 'https://rootsonrise.com' },
  publisher: {
    '@type': 'Organization',
    name: 'Roots On Rise',
    logo: { '@type': 'ImageObject', url: 'https://rootsonrise.com/images/brand/Brand-Logo-Name-Transparent-Background.svg' },
  },
  image: post.data.image ? `https://rootsonrise.com${post.data.image}` : undefined,
  mainEntityOfPage: { '@type': 'WebPage', '@id': `https://rootsonrise.com/blog/${postSlug}` },
  ...(post.data.keywords && { keywords: post.data.keywords.join(', ') }),
  audience: { '@type': 'Audience', audienceType: 'Children, Parents, Educators' },
  inLanguage: 'en-US',
};

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout
  title={`${post.data.title} | Roots On Rise Blog`}
  description={post.data.description}
  image={post.data.image}
  type="article"
>
  <script slot="structured-data" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <script slot="structured-data" type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Breadcrumb -->
  <Section background="tertiary" padding="sm" container="md">
    <nav class="text-sm text-dark/50" aria-label="Breadcrumb">
      <a href="/" class="hover:text-primary transition-colors">Home</a>
      <span class="mx-2">/</span>
      <a href="/blog" class="hover:text-primary transition-colors">Blog</a>
      <span class="mx-2">/</span>
      <span class="text-dark/70">{post.data.title}</span>
    </nav>
  </Section>

  <!-- Article -->
  <Section container="sm">
    <article>
      {post.data.image && (
        <div class="flex justify-center mb-10">
          <img
            src={post.data.image}
            alt={post.data.imageAlt || post.data.title}
            class="max-h-80 w-auto rounded-2xl shadow-sm"
          />
        </div>
      )}

      <header class="mb-10 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-xs font-semibold text-primary uppercase tracking-wider bg-primary/10 px-3 py-1 rounded-full">{post.data.category}</span>
          <span class="text-dark/40 text-sm">{formattedDate}</span>
          <span class="text-dark/40 text-sm">{post.data.ageRange}</span>
        </div>
        <h1 class="font-title font-bold text-3xl md:text-5xl text-dark mb-5 leading-tight">
          {post.data.title}
        </h1>
        <p class="text-dark/60 text-lg max-w-2xl mx-auto leading-relaxed">
          {post.data.description}
        </p>
      </header>

      <hr class="border-dark/10 mb-10" />

      <div class="prose prose-lg max-w-none
        prose-headings:font-title prose-headings:text-dark
        prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:font-bold
        prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
        prose-p:text-dark/70 prose-p:leading-relaxed prose-p:text-base
        prose-li:text-dark/70 prose-li:text-base
        prose-strong:text-primary prose-strong:font-semibold
        prose-a:text-primary prose-a:no-underline hover:prose-a:underline
        prose-ol:pl-6 prose-ul:pl-6
        prose-img:rounded-xl prose-img:shadow-sm
      ">
        <Content />
      </div>
    </article>
  </Section>

  <!-- More Stories -->
  {relatedPosts.length > 0 && (
    <Section background="light">
      <div class="text-center mb-10">
        <h2 class="font-title font-bold text-2xl md:text-3xl text-dark mb-3">
          more <span class="text-primary">stories</span> your family will love
        </h2>
        <p class="text-dark/60 max-w-md mx-auto text-sm">
          Continue exploring with more reading adventures for young minds.
        </p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto">
        {relatedPosts.map((related) => {
          const relatedSlug = related.id.replace(/\.md$/, '');
          return (
            <a href={`/blog/${relatedSlug}`}
              class="group block bg-white rounded-xl overflow-hidden border border-dark/5 hover:shadow-lg transition-shadow">
              {related.data.image && (
                <div class="aspect-[16/10] overflow-hidden bg-tertiary">
                  <img
                    src={related.data.image}
                    alt={related.data.imageAlt || related.data.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-4">
                <span class="inline-block text-xs font-semibold text-primary bg-primary/10 px-2 py-0.5 rounded-full mb-2">
                  {related.data.ageRange}
                </span>
                <h3 class="font-title font-bold text-dark text-sm leading-snug group-hover:text-primary transition-colors">
                  {related.data.title}
                </h3>
              </div>
            </a>
          );
        })}
      </div>
    </Section>
  )}

  <!-- Book Showcase — rotates between 3 styles so pages don't all look identical -->
  {ctaVariant === 0 && (
    /* Variant A: Horizontal banner — image left, formats right */
    <Section background="tertiary">
      {seriesToShow.map((series) => {
        const books = getBooksBySeriesId(series.id);
        const primaryBook = books[0];
        if (!primaryBook) return null;
        return (
          <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center gap-8 mb-8 last:mb-0">
            <div class="w-48 shrink-0">
              <img src={primaryBook.image} alt={series.name} class="w-full rounded-xl shadow-md" loading="lazy" />
            </div>
            <div class="flex-1 text-center md:text-left">
              <h2 class="font-title font-bold text-2xl text-dark mb-2">{series.name}</h2>
              <p class="text-dark/60 text-sm mb-4 max-w-md">{series.description}</p>
              <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                {series.formats.map((fmt) => (
                  <Button variant={fmt.id.includes('kindle') ? 'outline' : 'amazon'} size="sm" asChild>
                    <a href={getAmazonUrl(fmt.asin || '')} target="_blank" rel="noopener">
                      {fmt.name} — {fmt.price}
                    </a>
                  </Button>
                ))}
              </div>
            </div>
          </div>
        );
      })}
    </Section>
  )}

  {ctaVariant === 1 && (
    /* Variant B: Format comparison list — clean table-like layout */
    <Section background="gradientWarm">
      <div class="text-center mb-8">
        <h2 class="font-title font-bold text-2xl text-dark mb-2">
          bring these stories <span class="text-primary">home</span>
        </h2>
        <p class="text-dark/60 text-sm max-w-md mx-auto">Available in multiple formats to suit your family.</p>
      </div>
      <div class="max-w-2xl mx-auto space-y-4">
        {seriesToShow.flatMap((series) =>
          series.formats.map((fmt) => {
            const amazonUrl = getAmazonUrl(fmt.asin || '');
            return (
              <a href={amazonUrl} target="_blank" rel="noopener"
                class="flex items-center justify-between bg-white rounded-xl px-5 py-4 border border-dark/5 hover:shadow-md transition-shadow group">
                <div>
                  <p class="font-title font-bold text-dark group-hover:text-primary transition-colors">
                    {series.shortName} — {fmt.name}
                  </p>
                  {fmt.description && <p class="text-dark/50 text-sm">{fmt.description}</p>}
                </div>
                <span class="font-bold text-primary text-lg shrink-0 ml-4">{fmt.price}</span>
              </a>
            );
          })
        )}
      </div>
    </Section>
  )}

  {ctaVariant === 2 && (
    /* Variant C: Minimal callout — quote-style with single CTA */
    <Section background="dark" container="md">
      <div class="text-center">
        <p class="text-light/50 text-sm uppercase tracking-wider mb-3">From our bookshelf</p>
        <h2 class="font-title font-bold text-2xl md:text-3xl text-light mb-3">
          see these deities come to <span class="text-primary">life</span>
        </h2>
        <p class="text-light/60 max-w-lg mx-auto mb-8">
          Beautifully illustrated books that make Hindu mythology accessible and exciting for young readers.
        </p>
        <div class="flex flex-wrap gap-4 justify-center">
          {seriesToShow.map((series) => {
            const primaryFormat = series.formats[0];
            if (!primaryFormat) return null;
            return (
              <Button variant="amazon" size="lg" asChild>
                <a href={getAmazonUrl(primaryFormat.asin || '')} target="_blank" rel="noopener">
                  {series.shortName} — {primaryFormat.price}
                </a>
              </Button>
            );
          })}
        </div>
      </div>
    </Section>
  )}

  <!-- Related Content -->
  {relatedPage && (
    <Section>
      <div class="max-w-sm mx-auto text-center">
        <p class="text-dark/50 text-sm mb-2">Continue reading</p>
        <a href={`/${relatedPage.slug}`} class="font-title font-bold text-lg text-primary hover:underline">
          {relatedPage.heading} &rarr;
        </a>
      </div>
    </Section>
  )}

  <ExitIntentPopup contextHint={deityContextHint} />
</Layout>
