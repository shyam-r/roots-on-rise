---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ExitIntentPopup from '@/components/ExitIntentPopup.astro';
import MobileStickyBuy from '@/components/MobileStickyBuy.astro';
import BookPromoCard from '@/components/BookPromoCard.astro';
import BookPromoBanner from '@/components/BookPromoBanner.astro';
import { Section } from '@/components/ui';
import { BOOK_SERIES } from '@/data/products';
import { getLandingPageBySlug } from '@/data/landing-pages';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id.replace(/\.md$/, '') },
    props: { post },
  }));
}

const { post } = Astro.props;

const { Content } = await render(post);
const postSlug = post.id.replace(/\.md$/, '');

// Related blog posts: same category, excluding current post, limit to 3
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter((p) => p.data.category === post.data.category && p.id !== post.id)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 3);

// Extract deity name for context-aware exit intent popup
const deityContextHint = post.data.category === 'deity'
  ? post.data.title
      .replace(/^(Lord|Goddess|Meet)\s+/i, '')
      .replace(/[:\u2014\u2013\u2012].*$/, '')
      .trim()
  : undefined;

// Determine which book series to show based on blog post's relatedBook field
const seriesIds = post.data.relatedBook === 'deities'
  ? ['marvelous-hindu-deities']
  : post.data.relatedBook === 'shloka'
    ? ['shloka-mantra']
    : ['shloka-mantra', 'marvelous-hindu-deities'];

// Related landing page
const relatedPage = post.data.relatedSlug ? getLandingPageBySlug(post.data.relatedSlug) : null;

// Schemas
const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: 'https://rootsonrise.com' },
    { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://rootsonrise.com/blog' },
    { '@type': 'ListItem', position: 3, name: post.data.title, item: `https://rootsonrise.com/blog/${postSlug}` },
  ],
};

const articleSchema = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.date.toISOString(),
  author: { '@type': 'Organization', name: 'Roots On Rise', url: 'https://rootsonrise.com' },
  publisher: {
    '@type': 'Organization',
    name: 'Roots On Rise',
    logo: { '@type': 'ImageObject', url: 'https://rootsonrise.com/images/brand/Brand-Logo-Name-Transparent-Background.svg' },
  },
  image: post.data.image ? `https://rootsonrise.com${post.data.image}` : undefined,
  mainEntityOfPage: { '@type': 'WebPage', '@id': `https://rootsonrise.com/blog/${postSlug}` },
  ...(post.data.keywords && { keywords: post.data.keywords.join(', ') }),
  audience: { '@type': 'Audience', audienceType: 'Children, Parents, Educators' },
  inLanguage: 'en-US',
};

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<Layout
  title={`${post.data.title} | Roots On Rise Blog`}
  description={post.data.description}
  image={post.data.image}
  type="article"
>
  <script slot="structured-data" type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <script slot="structured-data" type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <!-- Breadcrumb -->
  <Section background="tertiary" padding="sm" container="md">
    <nav class="text-sm text-dark/50" aria-label="Breadcrumb">
      <a href="/" class="hover:text-primary transition-colors">Home</a>
      <span class="mx-2">/</span>
      <a href="/blog" class="hover:text-primary transition-colors">Blog</a>
      <span class="mx-2">/</span>
      <span class="text-dark/70">{post.data.title}</span>
    </nav>
  </Section>

  <!-- Article -->
  <Section container="sm">
    <article>
      {post.data.image && (
        <div class="flex justify-center mb-10">
          <img
            src={post.data.image}
            alt={post.data.imageAlt || post.data.title}
            class="max-h-80 w-auto rounded-2xl shadow-sm"
          />
        </div>
      )}

      <header class="mb-10 text-center">
        <div class="flex items-center justify-center gap-3 mb-4">
          <span class="text-xs font-semibold text-primary uppercase tracking-wider bg-primary/10 px-3 py-1 rounded-full">{post.data.category}</span>
          <span class="text-dark/40 text-sm">{formattedDate}</span>
          <span class="text-dark/40 text-sm">{post.data.ageRange}</span>
        </div>
        <h1 class="font-title font-bold text-3xl md:text-5xl text-dark mb-5 leading-tight">
          {post.data.title}
        </h1>
        <p class="text-dark/60 text-lg max-w-2xl mx-auto leading-relaxed">
          {post.data.description}
        </p>
      </header>

      <!-- Inline book card with format pills — above content -->
      <BookPromoCard seriesId={seriesIds[0]} className="mb-10" />

      <hr class="border-dark/10 mb-10" />

      <div class="prose prose-lg max-w-none
        prose-headings:font-title prose-headings:text-dark
        prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:font-bold
        prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-3
        prose-p:text-dark/70 prose-p:leading-relaxed prose-p:text-base
        prose-li:text-dark/70 prose-li:text-base
        prose-strong:text-primary prose-strong:font-semibold
        prose-a:text-primary prose-a:no-underline hover:prose-a:underline
        prose-ol:pl-6 prose-ul:pl-6
        prose-img:rounded-xl prose-img:shadow-sm
      ">
        <Content />
      </div>
    </article>
  </Section>

  <!-- Book Showcase — format pills with direct Amazon links -->
  <Section background="tertiary">
    <div class="max-w-4xl mx-auto space-y-10">
      {seriesIds.map((sid) => (
        <BookPromoBanner seriesId={sid} />
      ))}
    </div>
  </Section>

  <!-- More Stories -->
  {relatedPosts.length > 0 && (
    <Section background="light">
      <div class="text-center mb-10">
        <h2 class="font-title font-bold text-2xl md:text-3xl text-dark mb-3">
          more <span class="text-primary">stories</span> your family will love
        </h2>
        <p class="text-dark/60 max-w-md mx-auto text-sm">
          Continue exploring with more reading adventures for young minds.
        </p>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto">
        {relatedPosts.map((related) => {
          const relatedSlug = related.id.replace(/\.md$/, '');
          return (
            <a href={`/blog/${relatedSlug}`}
              class="group block bg-white rounded-xl overflow-hidden border border-dark/5 hover:shadow-lg transition-shadow">
              {related.data.image && (
                <div class="aspect-[16/10] overflow-hidden bg-tertiary">
                  <img
                    src={related.data.image}
                    alt={related.data.imageAlt || related.data.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-4">
                <span class="inline-block text-xs font-semibold text-primary bg-primary/10 px-2 py-0.5 rounded-full mb-2">
                  {related.data.ageRange}
                </span>
                <h3 class="font-title font-bold text-dark text-sm leading-snug group-hover:text-primary transition-colors">
                  {related.data.title}
                </h3>
              </div>
            </a>
          );
        })}
      </div>
    </Section>
  )}

  <!-- Related Content -->
  {relatedPage && (
    <Section>
      <div class="max-w-sm mx-auto text-center">
        <p class="text-dark/50 text-sm mb-2">Continue reading</p>
        <a href={`/${relatedPage.slug}`} class="font-title font-bold text-lg text-primary hover:underline">
          {relatedPage.heading} &rarr;
        </a>
      </div>
    </Section>
  )}

  <!-- Conversion tools — exit intent + mobile sticky buy -->
  <ExitIntentPopup contextHint={deityContextHint} />
  <MobileStickyBuy />
</Layout>
